---
title: "1_GWAS_Ancestry_Comparison"
author: "Jonathan Chan"
date: "13/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(magrittr)
library(RColorBrewer)
library(stringr)
library(tibble)
library(ggrepel)
```

# Comparison of Number of GWAS Participants by Self-Reported Ancestry

## Aim

The aim of this code is to output a comparative plot of the number of GWAS particpant by their ancestry to outline the ancestral disparities in population genetics studies. A reference plot can be found in Martin et al. (2019).

## Method

The GWAS Catalog (NHGRI-EBI) will be used as source of data for current GWAS studies - both published and unpublished.
Hence, their V1.0.3 ancestry dataset will be used as the base dataset: https://www.ebi.ac.uk/gwas/api/search/downloads/ancestries_new

The output .tsv file will be imported as a tibble (Tidyverse) into R and summary statistics across all studies will be carried out to derive a summary statistics table. This will then be transformed into a summative plot.

```{r Data_Import}
# Below code downloads the latest source data from GWAS catalog and imports it as a tibble into R and discarding columns which aren't required.
Sys.time()
download.file('https://www.ebi.ac.uk/gwas/api/search/downloads/ancestries_new', 'ancestry_GWAS.tsv')
base_data <- read_tsv('ancestry_GWAS.tsv') %>%
  filter(!str_detect(`BROAD ANCESTRAL CATEGORY`,'.?NR.?'))
  select(1,3,4,5,6,8,9)
```

The broad ancestral categories that will be compared  will be:
* European
* East Asian
* South/Other Asian
* African
* Hispanic/Latino
* Greater Middle Eastern
* Oceanian
* Other
* Multiple

Below code filters the dataset into individual tibbles corresponding to studies for each of the broad ancestral categories, excluding the non-reported multiple ancestry categories and simplifying labels to the broad ancestral categories, and then recombines them into a simplified tibble.

Note that additional filtering occurs to remove
* GWAS studies with NA values for the number of individuals involved

Note that the actual metric of number of GWAS participants means that the same individuals e.g of UK Biobank can be used for multiple GWASs for different traits both within the same publication and between different publications - hence predominance of European GWAS participants.

```{r Ancestry_Cleaner}
european <- filter(base_data, `BROAD ANCESTRAL CATEGORY` %in% c('European'))
e_asian <- filter(base_data, `BROAD ANCESTRAL CATEGORY` %in% c('East Asian', 'East Asian, Asian unspecified'))
e_asian$`BROAD ANCESTRAL CATEGORY` <- 'East Asian'
s_asian <- filter(base_data, `BROAD ANCESTRAL CATEGORY` %in% c('South Asian','South East Asian','Central Asian', 'Asian unspecified', 'South Asian, East Asian ', 'South Asian, South East Asian', 'South Asian, South East Asian, East Asian','South East Asian, East Asian', 'South East Asian, South Asian, East Asian'))
s_asian$`BROAD ANCESTRAL CATEGORY` <- 'South/Other Asian'
  
african <- filter(base_data, `BROAD ANCESTRAL CATEGORY` %in% c('African American or Afro-Caribbean','African unspecified', 'Sub-Saharan African', 'African American or Afro-Caribbean, African unspecified', 'African unspecified, African American or Afro-Caribbean', 'Sub-Saharan African, African unspecified', '	
African unspecified, Sub-Saharan African', 'Sub-Saharan African, African American or Afro-Caribbean'))
african$`BROAD ANCESTRAL CATEGORY` <- 'African'

hispanic <- filter(base_data, `BROAD ANCESTRAL CATEGORY` %in% c('Hispanic or Latin American'))
gme <- filter(base_data, `BROAD ANCESTRAL CATEGORY` %in% c('Greater Middle Eastern (Middle Eastern, North African or Persian)'))
gme$`BROAD ANCESTRAL CATEGORY` <- 'Greater Middle Eastern'

other <- filter(base_data, `BROAD ANCESTRAL CATEGORY` %in% c('Native American','Oceanian','Aboriginal Australian','Other','Other admixed ancestry'))
other$`BROAD ANCESTRAL CATEGORY` <- 'Other'

multiple <- filter(base_data, str_detect(`BROAD ANCESTRAL CATEGORY`, ',')) %>%
  filter(!(`BROAD ANCESTRAL CATEGORY`  %in%  c('Greater Middle Eastern (Middle Eastern, North African or Persian)', 'Sub-Saharan African, African American or Afro-Caribbean', 'Sub-Saharan African, African unspecified', 'East Asian, Asian unspecified', 'South Asian, East Asian ', 'South Asian, South East Asian', 'South Asian, South East Asian, East Asian','South East Asian, East Asian', 'South East Asian, South Asian, East Asian')))

multiple$`BROAD ANCESTRAL CATEGORY` <- 'Multiple'

total_simple_base_data <- bind_rows(european, e_asian, s_asian, african, hispanic, gme, other, multiple) %>%
  arrange(DATE) %>%
  filter(!is.na(`NUMBER OF INDIVIDUALS`)) %>%
  mutate(ANCESTRY = as.factor(`BROAD ANCESTRAL CATEGORY`))

#Calculating cumulative sum of GWAS participants per broad ancestral category
cum_simple_base_data <- total_simple_base_data %>%
  group_by(ANCESTRY) %>%
  mutate(CUMULATIVE_INDIVIDUALS = cumsum(as.numeric(`NUMBER OF INDIVIDUALS`))) %>% # Sums over all the studies within a single publication!
  group_by(DATE, ANCESTRY) %>%
  slice(which.max(CUMULATIVE_INDIVIDUALS)) #Takes the max cumulative value per date and per ancestry

#Creating a tibble where each study has an option to update each ancestry type over time so each ancestry spans all of the time period
expansion <- cum_simple_base_data %>%
    arrange(DATE) %>% 
    expand(DATE, ANCESTRY) %>% 
    distinct()

expanded_cum_data <- full_join(cum_simple_base_data, expansion, by=c('DATE', 'ANCESTRY')) %>%
  arrange(DATE)
expanded_cum_data$CUMULATIVE_INDIVIDUALS[2:10] <- 0 #Setting starting values of GWAS participants = 0 for non-Europeans

expanded_cum_data <- expanded_cum_data %>%
  group_by(ANCESTRY) %>%
  mutate(TIME_CUM = na.locf(CUMULATIVE_INDIVIDUALS, fromLast=F, na.rm=F))
```

The following code plots the comparative time series plot with one y-axis of millions of individuals. 

```{r Comparative_Plot}
#Plotting time series plot with cumulative sum

# Establishing the colour vector
col_vector <- brewer.pal(8,'Dark2')
names(col_vector) <- levels(expanded_cum_data$ANCESTRY)

#col_vector <- fct_rev(reorder(expanded_cum_data$ANCESTRY, expanded_cum_data$TIME_CUM))


p1 <- ggplot(expanded_cum_data)+
  geom_area(aes(x=as.Date(DATE), y=TIME_CUM/10^6, col = fct_rev(reorder(expanded_cum_data$ANCESTRY, expanded_cum_data$TIME_CUM)), fill = fct_rev(reorder(expanded_cum_data$ANCESTRY, expanded_cum_data$TIME_CUM))), position = 'stack')+
  ylab('Number of GWAS Participants (millions)')+
  xlab('')+
  scale_x_date(date_breaks = '2 years', date_labels = '%Y')+
  scale_colour_manual(values=col_vector)+
  scale_fill_manual(values=col_vector)+
  labs(fill='Ancestry',colour='Ancestry')+
  theme_classic() +
  theme(axis.text = element_text(color='black'),
        axis.text.x = element_text(angle=90, vjust=0.5, hjust=2),
        axis.title.y = element_text(vjust = 1.5),
        text = element_text(size=14),
        legend.position = c(0.05, 1),
        legend.justification = c(0, 1),
        legend.text = element_text(size=12),
        legend.background = element_rect(fill = "transparent", colour = NA))
  

ggsave('cumulative_sum_time_series.pdf', p1)
```

The following code plots the second plot with y-axis right-aligned of fold-change of number of individuals from 2019-2022 for each ancestry compared to 2016-2019 (non-inclusive upper bound) using the same colour palette as the first plot.

```{r Fold_Change_Plot}

earlier_period_data <- total_simple_base_data %>%
  filter(as.Date(DATE) >= ymd('2016-01-01') & as.Date(DATE) < ymd('2019-01-01')) %>%
  group_by(ANCESTRY) %>%
  summarise(EARLIER.PERIOD.SUM = sum(`NUMBER OF INDIVIDUALS`))

latter_period_data <- total_simple_base_data %>%
  filter(as.Date(DATE) >= ymd('2019-01-01') & as.Date(DATE) < ymd('2022-01-01')) %>%
  group_by(ANCESTRY) %>%
  summarise(LATER.PERIOD.SUM = sum(`NUMBER OF INDIVIDUALS`))

cumsum_ancestry <- expanded_cum_data %>%
  group_by(ANCESTRY) %>%
  summarise(MAX.CUMSUM = max(TIME_CUM))

combined_period_data <- full_join(earlier_period_data, latter_period_data) %>%
  full_join(cumsum_ancestry) %>%
  mutate(FOLD.CHANGE = LATER.PERIOD.SUM/EARLIER.PERIOD.SUM)

p2 <- ggplot(combined_period_data)+
  geom_boxplot(aes(x=1, y= FOLD.CHANGE), colour = 'black', fill='light grey', size = 1)+
  geom_point(aes(x=1, y=FOLD.CHANGE, col = fct_rev(reorder(ANCESTRY, MAX.CUMSUM))), size = 2.5)+
  scale_colour_manual(values=col_vector)+
  scale_x_discrete(breaks = NULL, labels=NULL) +
  scale_y_continuous(position = 'right', breaks=seq(0,30,2))+
  ylab('Fold Change from 2019-2022 vs. 2016-2019')+
  xlab('')+
  theme_classic()+
  theme(legend.position = 'none',
        axis.text = element_text(color='black'),
        axis.title.y = element_text(vjust =1.5),
        axis.line.x = element_line(linetype='blank'),
        axis.line.y = element_line(lineend='round'),
        text = element_text(size=14),
        plot.margin = unit(c(1, 7, 1, 7), "cm"))

ggsave('fold_change.pdf', p2)
```

